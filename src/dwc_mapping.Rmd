---
title: "Darwin Core mapping"
subtitle: "For: RATO - daily operations commissioned by the province East Flanders, Belgium"
author:
- Lien Reyserhove
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

# Setup 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

Install required libraries (only if the libraries have not been installed before):

```{r}
installed <- rownames(installed.packages())
required <- c("tidyverse", "tidylog", "magrittr", "here", "janitor", "readxl", "digest", "rgbif", "DBI", "RSQLite")
if (!all(required %in% installed)) {
  install.packages(required[!required %in% installed])
}
```

Load libraries:

```{r message = FALSE}
library(tidyverse)      # To do data science
library(tidylog)        # To provide feedback on dplyr functions
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(DBI)            # To create and query databases
library(RSQLite)        # To work with SQLite databases in R
library(rgbif)
library(purrr)
```


# Read source data

Create a data frame `input_data` from the source data:

```{r}
input_data <- read.csv(file = here("data", "raw", "rato_data.csv"),
                       header = T,
                       sep = ",") 
```

# Add scientific name

Add scientific names based on `gbif_code`

```{r}
input_data <- 
  input_data %>% 
  mutate(scientificName = purrr::map_chr(
  .data$GBIF_Code,
    function(x) {
    rgbif::name_usage(x)$data %>% pull(scientificName)
  })
)
input_data
```

## Create database

Create a SQLite database with the source data, so it can be queried with SQL in the next steps:

```{r create_db}
rato_db <- DBI::dbConnect(RSQLite::SQLite(), ":memory:")
# Import data
DBI::dbWriteTable(rato_db, "input_data", input_data)
```

# Darwin Core mapping

Create [Event Core](link):

```{r occurrence}
dwc_event_sql <- glue::glue_sql(readr::read_file(here::here("sql", "dwc_event.sql")), .con = rato_db)
dwc_event <- DBI::dbGetQuery(rato_db, dwc_event_sql)
```

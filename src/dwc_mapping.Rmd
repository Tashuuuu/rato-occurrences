---
title: "Darwin Core mapping"
subtitle: "For: The (...) occurrences of "
author:
- author_1
- author_2
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
#  pdf_document:
#    df_print: kable
#    number_sections: yes
#    toc: yes
#    toc_depth: 3
---

# Setup 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

Install required libraries (only if the libraries have not been installed before):

```{r}
installed <- rownames(installed.packages())
required <- c("tidyverse", "tidylog", "magrittr", "here", "janitor", "readxl", "digest", "rgbif")
if (!all(required %in% installed)) {
  install.packages(required[!required %in% installed])
}
```

Load libraries:

```{r message = FALSE}
library(tidyverse)      # To do data science
library(tidylog)        # To provide feedback on dplyr functions
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(digest)         # To generate hashes
library(sf)
```

# Read source data

Create a data frame `input_data` from the source data:

```{r}
input_data <- read.csv(file = here("data", "raw", "rato_data.csv"),
                       header = T,
                       sep = ",") 
```

Preview data:

```{r}
input_data %>% head(n = 5)
```

# Process source data

## Tidy data

Clean data somewhat:

```{r}
input_data <- 
  input_data %>% 
    remove_empty("rows") %>% 
    clean_names()
```

`object_id` is the unique identifier for each occurrence. This will be the `occurrenceID`. This field should contain unique values only. 

`dossier_id` is the unique identifier for each sampling event. This will be the `eventID`

Check whether `object_id` is unique (value should be `0`)

```{r}
anyDuplicated(input_data$objectid)
```
Remove all rows for `Domein` = `Werken` 

```{r}
input_data %<>% filter(domein != "Werken")
```

## Define eventID and occurrenceID


```{r}
input_data <- 
  input_data %>% 
    mutate(event_id = dossier_id) %>% 
    mutate(occurrence_id = objectid)

```

## Extract information from "waarnemingen"  

The field `waarnemingen` is used to map `organismQuantity`, `organismQuantityType` and `occurrenceStatus`. This fields need to be cleaned before mapping. 

```{r}
input_data %>% 
  group_by(waarneming) %>% 
  summarise(records = n())
```

Split into different columns: `waarneming_type` and `waarneming_kwantiteit`:

```{r}
input_data <- 
  input_data %>% 

    # First, separate `waarneming` into `waarneming_type` and `waarneming_kwantiteit`:
    separate(                                   
      col = waarneming,
      into = c("waarneming_type", "waarneming_kwantiteit"),
      sep = "\\s=\\s",
      remove = FALSE) %>% 

    # Clean waarneming_kwantiteit:
    mutate(waarneming_kwantiteit = str_remove(
      string = waarneming_kwantiteit,
      pattern = ";"))
```
Map `Organism_quantity`:

```{r}
input_data %<>% 
  mutate(organism_quantity = case_when(
    waarneming_type == "Vastgesteld (in mÂ²)" |
    waarneming_type == "Vastgesteld (aantal)" ~ waarneming_kwantiteit,
    TRUE ~ ""
  )) 
```
Map `organism_quantity_type`:

```{r}
input_data <-
  input_data %>% 
    mutate(organism_quantity_type = case_when(
      waarneming_type == "Vastgesteld (in mÂ²)" ~ "square meter(s)",
      waarneming_type == "Vastgesteld (aantal)" ~ "individual(s)",
      TRUE ~ ""
    ))
``` 
Map `occurrence_status`:

```{r}
input_data <-
  input_data %>%
    mutate(occurrence_status = case_when(
      waarneming_type == "Haard vastgesteld" |
      waarneming_type == "Nest vastgesteld" |
      waarneming_type == "Vastgesteld" |
      waarneming_type == "Vastgesteld (in mÂ²)" |
      waarneming_type == "Vastgesteld (aantal)" 
        ~ "present",
      
      waarneming_type == "Geen haard vastgesteld" |
      waarneming_type == "Niet vastgesteld" 
        ~ "absent",
      
      waarneming_type == "Waarneming onzeker" ~ "uncertain",
      
      TRUE ~ ""
    ))
```

## Extract information from "materiaal_vast"  

Information from `materiaal_vast` can be used for `samplingProtocol`

```{r}
input_data %>% 
  group_by(materiaal_vast) %>% 
  summarise(records = n()) %>% 
  arrange (records)
```

First split on ";" and separate on "="

```{r}
sampling_protocol <-
  input_data %>% 
    select(occurrence_id, materiaal_vast) %>% 

    # separate on ";" and split in different rows:
    separate_rows(
      "materiaal_vast",
      sep = ";\\s") %>% 
  
    # separate on " = " and split in different columns:
    separate(
      col = materiaal_vast,
      sep = "\\s=\\s",
      into = c("materiaal", "kwantiteit"))  %>% 
      
    # remove "(aantal)" for easier mapping:
   mutate(materiaal = str_remove(materiaal,"\\s\\(aantal\\)")) %>% 
  
    # remove all rows for which `kwantiteit = NA
  filter(!is.na(kwantiteit))
```
Resulting materials:

```{r}
sampling_protocol %>% 
  select(materiaal) %>% 
  group_by_all() %>% 
  summarise(records = n())
```
Translate to English (generate `protocol`):

```{r}
sampling_protocol %<>% 
  mutate(protocol = recode(materiaal,
    "Andere" = "other",
    "Conibearklem" = "conibear trap(s)",
    "Fuik" = "fike(s)",
    "Grondklem" = "ground trap(s)",
    "Klemvlot" = "",
    "Lokaasklem" = "bait trap",
    "Materiaal gesaboteerd" = "",
    "Slagnet" = "",
    "Vangkooi" = "cage",
    "Vangnet" = "net",
    "Wildcamera" = "camera trap"))
```
Add `effort`:

```{r}
sampling_protocol %<>% 
  mutate(effort = case_when(
    kwantiteit == "0" ~ "",
    TRUE ~ paste(protocol, kwantiteit, sep = "=")))
```
Combine sampling efforts and methods per `occurrence_id`

```{r}
sampling_protocol <-
  sampling_protocol %>%
    group_by(occurrence_id) %>%
    summarise(sampling_protocol = paste(protocol, collapse = " | "),
              sampling_effort = paste(effort, collapse = " | "))
```
Merge dataset:

```{r}
input_data %<>% left_join(
  y = sampling_protocol,
  by = "occurrence_id")
```
## Transform Lambert coordinates to WGS84

Coordinates in `x` and `y` are given in the Belgian Lambert system, they should be transformed to World Geodetic System 84 coordinate system

```{r}
input_data %>%
    st_as_sf(coords = c("x", "y"), crs = 31370) %>% 
    st_transform(crs = 4326) %>%
    as.data.frame() %>%
    rename(decimal_longitude = x,
           decimal_latitude = y)%>%
    bind_cols(input_data) %>%
    relocate(colnames(input_data))
head(input_data)
```


 %>%
    st_transform(crs = 4326) %>%
    st_coordinates() %>%
    as.data.frame() %>%
    rename(decimal_longitude = X,
           decimal_latitude = Y) 

# Darwin Core mapping

```{r}
input_data %>% transmute(
  type = "Event",
  language = "en", 
  license = "http://creativecommons.org/publicdomain/zero/1.0/", 
  rightsHolder = "RATO", 
  datasetID = "", 
  institutionCode = "RATO", 
  datasetName = "RATO - daily operations commissioned by the province East Flanders, Belgium", 
  basisOfRecord = "humanObservation", 
  dwc_eventID = event_id, 
  recordedBy = "RATO", 
  organismQuantity = organism_quantity, 
  organismQuantityType = organism_quantity_type,
  occurrenceStatus = occurrence_status,
  samplingProtocol = sampling_protocol,
  samplingEffort = sampling_effort,
  eventDate = as.POSIXct(aangemaakt_datum), 
  countryCode = "BE", 
  verbatimLatitude = y,
  verbatimLongitude = x,
  verbatimCoordinateSystem = "Lambert coordinates",
  verbatimSRS = "Belgian Datum 1972") 
  
  
  
```

<!-- ### samplingEffort -->

<!-- ### eventDate -->

<!-- ```{r} -->
<!-- event %<>% mutate(dwc_eventDate = as.Date(aangemaakt_datum)) -->
<!-- ``` -->

<!-- ### countryCode -->

<!-- ```{r} -->
<!-- event %<>% mutate(dwc_countryCode = "BE"%>%  -->
<!-- ``` -->

<!-- ### verbatimLatitude -->

<!-- ```{r} -->
<!-- event %<>% mutate(dwc_verbatimLatitude = y)  -->
<!-- ``` -->
<!-- ### verbatimLongitude -->

<!-- ```{r} -->
<!-- event %<>% mutate(dwc_verbatimLongitude = x)  -->
<!-- ``` -->

<!-- ### verbatimCoordinateSystem -->

<!-- ```{r} -->
<!-- event %<>% mutate(dwc_verbatimCoordinateSystem = "Lambert coordinates" )  -->
<!-- ``` -->

<!-- ### verbatimSRS -->

<!-- ```{r} -->
<!-- event %<>% mutate(dwc_verbatimSRS = "Belgian Datum 1972" )  -->
<!-- ``` -->


<!-- ### decimalLatitude and decimalLongitude -->

<!-- ```{r} -->
<!-- event <-  -->
<!--   event %>% -->
<!--     st_as_sf(coords = c("x", "y"), crs = 31370) %>% -->
<!--     st_transform(crs = 4326) %>% -->
<!--     st_coordinates() %>% -->
<!--     as.data.frame() %>% -->
<!--     rename(dwc_decimalLongitude = X, -->
<!--            dwc_decimalLatitude = Y) %>% -->
<!--     bind_cols(event) %>% -->
<!--     relocate(colnames(event)) -->
<!-- head(event) -->
<!-- ``` -->

<!-- ## geodeticDatum -->

<!-- ```{r} -->
<!-- event %<>% mutate(dwc_geodeticDatum = "WGS84" )  -->
<!-- ``` -->

<!-- ## coordinateUncertainty -->

<!-- ```{r} -->
<!-- occurrence %<>% mutate(dwc_coordinateUncertainty = "30")  -->
<!-- ``` -->


<!-- ### scientificName -->



<!-- ### kingdom -->

<!-- Inspect values: -->

<!-- ```{r} -->
<!-- occurrence %>% -->
<!--   group_by(domein) %>% -->
<!--   count() -->
<!-- ``` -->

<!-- Map values: -->

<!-- ```{r} -->
<!-- occurrence %>% mutate(dwc_kingdom = case_when( -->
<!--   domein == "Dier" ~ "Animalia", -->
<!--   domein == "Plant" ~ "Plantae" -->
<!-- )) -->
<!-- ``` -->


<!-- ### taxonRank -->

<!-- Inspect values: -->

<!-- ```{r} -->
<!-- taxon %>% -->
<!--   group_by(rankmarker) %>% -->
<!--   count() -->
<!-- ``` -->

<!-- Map values by recoding to the [GBIF rank vocabulary](http://rs.gbif.org/vocabulary/gbif/rank_2015-04-24.xml): -->

<!-- ```{r} -->
<!-- taxon %<>% mutate(dwc_taxonRank = recode(rankmarker, -->
<!--   "agg."      = "speciesAggregate", -->
<!--   "infrasp."  = "infraspecificname", -->
<!--   "sp."       = "species", -->
<!--   "var."      = "variety", -->
<!--   .default    = "", -->
<!--   .missing    = "" -->
<!-- )) -->
<!-- ``` -->

<!-- Inspect mapped values:  -->

<!-- ```{r} -->
<!-- taxon %>% -->
<!--   group_by(rankmarker, dwc_taxonRank) %>% -->
<!--   count() -->
<!-- ``` -->

<!-- ### nomenclaturalCode -->

<!-- ```{r} -->
<!-- taxon %<>% mutate(dwc_nomenclaturalCode = "my_nomenclaturalCode") # e.g. "ICZN" -->
<!-- ``` -->

<!-- ## Post-processing -->

<!-- Only keep the Darwin Core columns: -->

<!-- ```{r} -->
<!-- taxon %<>% select(starts_with("dwc_")) -->
<!-- ``` -->

<!-- Drop the `dwc_` prefix: -->

<!-- ```{r} -->
<!-- colnames(taxon) <- str_remove(colnames(taxon), "dwc_") -->
<!-- ``` -->

<!-- Preview data: -->

<!-- ```{r} -->
<!-- taxon %>% head() -->
<!-- ``` -->

<!-- Save to CSV: -->

<!-- ```{r} -->
<!-- write_csv(taxon, here("data", "processed", "taxon.csv"), na = "") -->
<!-- ``` -->

<!-- # Distribution extension -->

<!-- ## Pre-processing -->

<!-- Create a dataframe with all data: -->

<!-- ```{r} -->
<!-- distribution <- input_data -->
<!-- ``` -->

<!-- ## Term mapping -->

<!-- Map the data to [Species Distribution](http://rs.gbif.org/extension/gbif/1.0/distribution.xml). -->

<!-- ### taxonID -->

<!-- ```{r} -->
<!-- distribution %<>% mutate(dwc_taxonID = taxon_id) -->
<!-- ``` -->

<!-- ### locality -->

<!-- Inspect values: -->

<!-- ```{r} -->
<!-- distribution %>% -->
<!--   group_by(country_code, locality) %>% -->
<!--   count() -->
<!-- ``` -->

<!-- Map values to `locality` if provided, otherwise use the country name: -->

<!-- ```{r} -->
<!-- distribution %<>% mutate(dwc_locality = case_when( -->
<!--   !is.na(locality) ~ locality, -->
<!--   country_code == "BE" ~ "Belgium", -->
<!--   country_code == "GB" ~ "United Kingdom", -->
<!--   country_code == "MK" ~ "Macedonia", -->
<!--   country_code == "NL" ~ "The Netherlands", -->
<!--   TRUE ~ "" # In other cases leave empty -->
<!-- )) -->
<!-- ``` -->

<!-- Inspect mapped values:  -->

<!-- ```{r} -->
<!-- distribution %>% -->
<!--   group_by(country_code, locality, dwc_locality) %>% -->
<!--   count() -->
<!-- ``` -->

<!-- ### countryCode -->

<!-- Inspect values: -->

<!-- ```{r} -->
<!-- distribution %>% -->
<!--   group_by(country_code) %>% -->
<!--   count() -->
<!-- ``` -->

<!-- Map values: -->

<!-- ```{r} -->
<!-- distribution %<>% mutate(dwc_countryCode = country_code)  -->
<!-- ``` -->

<!-- ### occurrenceStatus -->

<!-- Inspect values: -->

<!-- ```{r} -->
<!-- distribution %>% -->
<!--   group_by(occurrence_status) %>% -->
<!--   count() -->
<!-- ``` -->

<!-- Map values: -->

<!-- ```{r} -->
<!-- distribution %<>% mutate(dwc_occurrenceStatus = occurrence_status)  -->
<!-- ``` -->

<!-- ### threatStatus -->

<!-- Inspect values: -->

<!-- ```{r} -->
<!-- distribution %>% -->
<!--   group_by(threat_status) %>% -->
<!--   count() -->
<!-- ``` -->

<!-- Map values by recoding to the [IUCN threat status vocabulary](http://rs.gbif.org/vocabulary/iucn/threat_status.xml): -->

<!-- ```{r} -->
<!-- distribution %<>% mutate(dwc_threatStatus = recode(threat_status, -->
<!--   "endangered" = "EN", -->
<!--   "vulnerable" = "VU" -->
<!-- )) -->
<!-- ``` -->

<!-- Inspect mapped values:  -->

<!-- ```{r} -->
<!-- distribution %>% -->
<!--   group_by(threat_status, dwc_threatStatus) %>% -->
<!--   count() -->
<!-- ``` -->

<!-- ### source -->

<!-- Inspect values: -->

<!-- ```{r} -->
<!-- distribution %>% -->
<!--   group_by(source) %>% -->
<!--   count() %>% -->
<!--   head() # Remove to show all values -->
<!-- ``` -->

<!-- Map values: -->

<!-- ```{r} -->
<!-- distribution %<>% mutate(dwc_source = source)  -->
<!-- ``` -->

<!-- ### occurrenceRemarks -->

<!-- Inspect values: -->

<!-- ```{r} -->
<!-- distribution %>% -->
<!--   group_by(remarks) %>% -->
<!--   count() %>% -->
<!--   head() # Remove to show all values -->
<!-- ``` -->

<!-- Map values: -->

<!-- ```{r} -->
<!-- distribution %<>% mutate(dwc_occurrenceRemarks = remarks)  -->
<!-- ``` -->

<!-- ## Post-processing -->

<!-- Only keep the Darwin Core columns: -->

<!-- ```{r} -->
<!-- distribution %<>% select(starts_with("dwc_")) -->
<!-- ``` -->

<!-- Drop the `dwc_` prefix: -->

<!-- ```{r} -->
<!-- colnames(distribution) <- str_remove(colnames(distribution), "dwc_") -->
<!-- ``` -->

<!-- Preview data: -->

<!-- ```{r} -->
<!-- distribution %>% head() -->
<!-- ``` -->

<!-- Save to CSV: -->

<!-- ```{r} -->
<!-- write_csv(distribution, here("data", "processed", "distribution.csv"), na = "") -->
<!-- ``` -->
